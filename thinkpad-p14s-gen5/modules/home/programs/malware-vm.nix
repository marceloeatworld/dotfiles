# Malware Analysis VM management with network killswitch
# Uses libvirt/QEMU for proper isolation
{ pkgs, ... }:

let
  malware-vm = pkgs.writeShellScriptBin "malware-vm" ''
    #!/usr/bin/env bash

    VM_NAME="Windows-Malware"
    ISOLATED_NET="malware-isolated"
    NAT_NET="malware-nat"

    # Colors
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    check_vm_exists() {
      ${pkgs.libvirt}/bin/virsh list --all --name 2>/dev/null | grep -q "^$VM_NAME$"
    }

    get_network_status() {
      CURRENT_NET=$(${pkgs.libvirt}/bin/virsh domiflist "$VM_NAME" 2>/dev/null | grep -E "network|bridge" | awk '{print $3}')
      echo "$CURRENT_NET"
    }

    create_networks() {
      # Create isolated network (no internet, VM-only)
      if ! ${pkgs.libvirt}/bin/virsh net-info "$ISOLATED_NET" &>/dev/null; then
        echo "Creating isolated network..."
        cat << 'NETXML' | ${pkgs.libvirt}/bin/virsh net-define /dev/stdin
<network>
  <name>malware-isolated</name>
  <bridge name="virbr-malware"/>
  <ip address="192.168.100.1" netmask="255.255.255.0">
    <dhcp>
      <range start="192.168.100.10" end="192.168.100.50"/>
    </dhcp>
  </ip>
</network>
NETXML
        ${pkgs.libvirt}/bin/virsh net-start "$ISOLATED_NET"
        ${pkgs.libvirt}/bin/virsh net-autostart "$ISOLATED_NET"
      fi

      # Create NAT network (internet access for initial setup/downloads)
      if ! ${pkgs.libvirt}/bin/virsh net-info "$NAT_NET" &>/dev/null; then
        echo "Creating NAT network..."
        cat << 'NETXML' | ${pkgs.libvirt}/bin/virsh net-define /dev/stdin
<network>
  <name>malware-nat</name>
  <forward mode="nat"/>
  <bridge name="virbr-malnat"/>
  <ip address="192.168.101.1" netmask="255.255.255.0">
    <dhcp>
      <range start="192.168.101.10" end="192.168.101.50"/>
    </dhcp>
  </ip>
</network>
NETXML
        ${pkgs.libvirt}/bin/virsh net-start "$NAT_NET"
        ${pkgs.libvirt}/bin/virsh net-autostart "$NAT_NET"
      fi
    }

    switch_network() {
      local TARGET_NET="$1"
      local CURRENT_MAC=$(${pkgs.libvirt}/bin/virsh domiflist "$VM_NAME" 2>/dev/null | grep -E "network" | awk '{print $5}')

      if [ -z "$CURRENT_MAC" ]; then
        echo -e "''${RED}Error: Could not get MAC address''${NC}"
        return 1
      fi

      # Detach current interface
      ${pkgs.libvirt}/bin/virsh detach-interface "$VM_NAME" network --mac "$CURRENT_MAC" --live 2>/dev/null || true

      # Attach to new network
      ${pkgs.libvirt}/bin/virsh attach-interface "$VM_NAME" network "$TARGET_NET" --mac "$CURRENT_MAC" --model virtio --live
    }

    network_on() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      echo -e "''${YELLOW}âš ï¸  WARNING: Enabling network access for malware VM!''${NC}"
      echo ""
      read -p "Are you sure? (yes/no): " CONFIRM
      if [ "$CONFIRM" != "yes" ]; then
        echo "Cancelled"
        exit 0
      fi

      switch_network "$NAT_NET"
      echo ""
      echo -e "''${GREEN}âœ… Network ENABLED''${NC}"
      echo -e "''${YELLOW}âš ï¸  Remember to run 'malware-vm killswitch' before analyzing malware!''${NC}"
      ${pkgs.libnotify}/bin/notify-send -u critical "Malware VM" "Network ENABLED - Be careful!"
    }

    killswitch() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      switch_network "$ISOLATED_NET"
      echo ""
      echo -e "''${GREEN}ðŸ”’ KILLSWITCH ACTIVATED - Network ISOLATED''${NC}"
      echo "VM can no longer reach the internet"
      ${pkgs.libnotify}/bin/notify-send "Malware VM" "Network ISOLATED - Safe to analyze"
    }

    status() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        echo ""
        echo "Create VM with: virt-manager"
        echo "Name it exactly: $VM_NAME"
        exit 1
      fi

      VM_STATE=$(${pkgs.libvirt}/bin/virsh domstate "$VM_NAME" 2>/dev/null)
      CURRENT_NET=$(get_network_status)

      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  Malware Analysis VM Status"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "  VM State:    $VM_STATE"

      if [ "$CURRENT_NET" = "$ISOLATED_NET" ]; then
        echo -e "  Network:     ''${GREEN}ðŸ”’ ISOLATED (safe)''${NC}"
      elif [ "$CURRENT_NET" = "$NAT_NET" ]; then
        echo -e "  Network:     ''${RED}âš ï¸  NAT (internet access!)''${NC}"
      else
        echo -e "  Network:     ''${YELLOW}$CURRENT_NET''${NC}"
      fi
      echo ""

      # Show snapshots
      echo "  Snapshots:"
      ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --name 2>/dev/null | while read snap; do
        [ -n "$snap" ] && echo "    - $snap"
      done
      echo ""
    }

    snapshot_create() {
      local SNAP_NAME="''${1:-clean-$(date +%Y%m%d-%H%M%S)}"

      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      echo "Creating snapshot '$SNAP_NAME'..."
      ${pkgs.libvirt}/bin/virsh snapshot-create-as "$VM_NAME" --name "$SNAP_NAME" --description "Malware analysis snapshot"
      echo -e "''${GREEN}âœ… Snapshot '$SNAP_NAME' created''${NC}"
    }

    snapshot_restore() {
      local SNAP_NAME="$1"

      if [ -z "$SNAP_NAME" ]; then
        echo "Available snapshots:"
        ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --name
        echo ""
        read -p "Enter snapshot name to restore: " SNAP_NAME
      fi

      if [ -z "$SNAP_NAME" ]; then
        echo "No snapshot specified"
        exit 1
      fi

      echo "Restoring snapshot '$SNAP_NAME'..."
      ${pkgs.libvirt}/bin/virsh snapshot-revert "$VM_NAME" --snapshotname "$SNAP_NAME"
      echo -e "''${GREEN}âœ… Restored to '$SNAP_NAME'''${NC}"

      # Auto-killswitch after restore
      killswitch
    }

    snapshot_list() {
      ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --tree
    }

    start_vm() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      # Always start in isolated mode
      echo "Starting VM in ISOLATED mode..."
      ${pkgs.libvirt}/bin/virsh start "$VM_NAME" 2>/dev/null || true

      sleep 2
      killswitch

      echo ""
      echo "Opening virt-viewer..."
      ${pkgs.virt-viewer}/bin/virt-viewer --connect qemu:///system "$VM_NAME" &
    }

    show_help() {
      cat << 'EOF'
Malware Analysis VM Manager

Usage: malware-vm <command> [options]

Network Commands:
  killswitch          Isolate VM from network (SAFE MODE)
  network-on          Enable internet (for downloads/updates)
  status              Show VM and network status

Snapshot Commands:
  snapshot [name]     Create a snapshot (default: timestamped)
  restore [name]      Restore to a snapshot (auto-killswitch)
  snapshots           List all snapshots

VM Commands:
  start               Start VM in isolated mode
  setup               Create required networks

Workflow:
  1. Create VM in virt-manager named "Windows-Malware"
  2. Run: malware-vm network-on
  3. Install Windows, tools, updates
  4. Run: malware-vm snapshot clean
  5. Run: malware-vm killswitch
  6. Analyze malware...
  7. Run: malware-vm restore clean

EOF
    }

    # Main
    case "$1" in
      killswitch|kill|off)
        killswitch
        ;;
      network-on|on|net)
        network_on
        ;;
      status|s)
        status
        ;;
      snapshot|snap)
        snapshot_create "$2"
        ;;
      restore|revert)
        snapshot_restore "$2"
        ;;
      snapshots|list)
        snapshot_list
        ;;
      start)
        start_vm
        ;;
      setup)
        create_networks
        echo -e "''${GREEN}âœ… Networks created''${NC}"
        ;;
      help|--help|-h|"")
        show_help
        ;;
      *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
    esac
  '';
in
{
  home.packages = [
    malware-vm
    pkgs.virt-viewer  # For viewing VMs
  ];
}
