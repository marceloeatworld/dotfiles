# Malware Analysis VM management with network killswitch
# Uses libvirt/QEMU for proper isolation
{ pkgs, ... }:

let
  malware-vm = pkgs.writeShellScriptBin "malware-vm" ''
    #!/usr/bin/env bash

    VM_NAME="Windows-Malware"
    ISOLATED_NET="malware-isolated"
    NAT_NET="malware-nat"

    # Colors
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    check_vm_exists() {
      ${pkgs.libvirt}/bin/virsh list --all --name 2>/dev/null | grep -q "^$VM_NAME$"
    }

    get_network_status() {
      CURRENT_NET=$(${pkgs.libvirt}/bin/virsh domiflist "$VM_NAME" 2>/dev/null | grep -E "network|bridge" | awk '{print $3}')
      echo "$CURRENT_NET"
    }

    create_nwfilter() {
      # Create nwfilter that blocks ALL traffic (maximum isolation)
      if ! ${pkgs.libvirt}/bin/virsh nwfilter-list | grep -q "malware-block-all"; then
        echo "Creating nwfilter 'malware-block-all'..."
        cat << 'FILTERXML' | ${pkgs.libvirt}/bin/virsh nwfilter-define /dev/stdin
<filter name='malware-block-all' chain='root'>
  <uuid>d217f2e8-e8f5-4858-9c6a-9e5c6c6c6c6c</uuid>
  <!-- Block ALL outgoing traffic to external networks -->
  <rule action='drop' direction='out' priority='100'>
    <all/>
  </rule>
  <!-- Block ALL incoming traffic from external networks -->
  <rule action='drop' direction='in' priority='100'>
    <all/>
  </rule>
  <!-- Allow only DHCP (required for VM to get IP from libvirt) -->
  <rule action='accept' direction='out' priority='50'>
    <udp srcportstart='68' dstportstart='67'/>
  </rule>
  <rule action='accept' direction='in' priority='50'>
    <udp srcportstart='67' dstportstart='68'/>
  </rule>
  <!-- Allow ARP (required for basic networking) -->
  <rule action='accept' direction='inout' priority='50'>
    <mac protocolid='arp'/>
  </rule>
</filter>
FILTERXML
        echo "nwfilter 'malware-block-all' created"
      fi
    }

    create_networks() {
      # First create the nwfilter
      create_nwfilter

      # Create isolated network (NO forward element = no external access)
      # According to libvirt docs: "guests can talk to each other and host,
      # but cannot reach any other machines on the LAN"
      if ! ${pkgs.libvirt}/bin/virsh net-info "$ISOLATED_NET" &>/dev/null; then
        echo "Creating isolated network (no internet access)..."
        cat << 'NETXML' | ${pkgs.libvirt}/bin/virsh net-define /dev/stdin
<network>
  <name>malware-isolated</name>
  <bridge name="virbr-malware"/>
  <!-- NO <forward> element = completely isolated from external networks -->
  <!-- Port isolation prevents guests from seeing each other too -->
  <port isolated="yes"/>
  <ip address="192.168.100.1" netmask="255.255.255.0">
    <dhcp>
      <range start="192.168.100.10" end="192.168.100.50"/>
    </dhcp>
  </ip>
</network>
NETXML
        ${pkgs.libvirt}/bin/virsh net-start "$ISOLATED_NET"
        ${pkgs.libvirt}/bin/virsh net-autostart "$ISOLATED_NET"
      fi

      # Create NAT network (internet access for initial setup/downloads)
      if ! ${pkgs.libvirt}/bin/virsh net-info "$NAT_NET" &>/dev/null; then
        echo "Creating NAT network (internet access)..."
        cat << 'NETXML' | ${pkgs.libvirt}/bin/virsh net-define /dev/stdin
<network>
  <name>malware-nat</name>
  <forward mode="nat">
    <nat>
      <port start="1024" end="65535"/>
    </nat>
  </forward>
  <bridge name="virbr-malnat"/>
  <ip address="192.168.101.1" netmask="255.255.255.0">
    <dhcp>
      <range start="192.168.101.10" end="192.168.101.50"/>
    </dhcp>
  </ip>
</network>
NETXML
        ${pkgs.libvirt}/bin/virsh net-start "$NAT_NET"
        ${pkgs.libvirt}/bin/virsh net-autostart "$NAT_NET"
      fi
    }

    switch_network() {
      local TARGET_NET="$1"
      local CURRENT_MAC=$(${pkgs.libvirt}/bin/virsh domiflist "$VM_NAME" 2>/dev/null | grep -E "network" | awk '{print $5}')

      if [ -z "$CURRENT_MAC" ]; then
        echo -e "''${RED}Error: Could not get MAC address''${NC}"
        return 1
      fi

      # Detach current interface
      ${pkgs.libvirt}/bin/virsh detach-interface "$VM_NAME" network --mac "$CURRENT_MAC" --live 2>/dev/null || true

      # Attach to new network
      ${pkgs.libvirt}/bin/virsh attach-interface "$VM_NAME" network "$TARGET_NET" --mac "$CURRENT_MAC" --model virtio --live
    }

    network_on() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      echo -e "''${YELLOW}âš ï¸  WARNING: Enabling network access for malware VM!''${NC}"
      echo ""
      read -p "Are you sure? (yes/no): " CONFIRM
      if [ "$CONFIRM" != "yes" ]; then
        echo "Cancelled"
        exit 0
      fi

      switch_network "$NAT_NET"
      echo ""
      echo -e "''${GREEN}âœ… Network ENABLED''${NC}"
      echo -e "''${YELLOW}âš ï¸  Remember to run 'malware-vm killswitch' before analyzing malware!''${NC}"
      ${pkgs.libnotify}/bin/notify-send -u critical "Malware VM" "Network ENABLED - Be careful!"
    }

    killswitch() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      # Ensure nwfilter exists
      create_nwfilter

      switch_network "$ISOLATED_NET"

      # Double protection: verify iptables rules are in place
      echo "Verifying isolation..."

      # Check if the bridge has no route to external networks
      if ip route | grep -q "virbr-malware"; then
        ROUTE_STATUS="Bridge route exists (internal only)"
      else
        ROUTE_STATUS="No external routes"
      fi

      echo ""
      echo -e "''${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•''${NC}"
      echo -e "''${GREEN}  ğŸ”’ KILLSWITCH ACTIVATED''${NC}"
      echo -e "''${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•''${NC}"
      echo ""
      echo "  Protection layers:"
      echo "    âœ“ Network: isolated (no <forward> element)"
      echo "    âœ“ Port isolation: enabled (guests can't see each other)"
      echo "    âœ“ nwfilter: blocks all non-DHCP/ARP traffic"
      echo "    âœ“ $ROUTE_STATUS"
      echo ""
      echo -e "  ''${GREEN}VM cannot reach the internet or LAN''${NC}"
      echo ""

      ${pkgs.libnotify}/bin/notify-send "Malware VM" "ğŸ”’ KILLSWITCH ACTIVE - Network isolated"
    }

    verify_isolation() {
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  Network Isolation Verification"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""

      # Check network type
      CURRENT_NET=$(get_network_status)
      if [ "$CURRENT_NET" = "$ISOLATED_NET" ]; then
        echo -e "  âœ“ Network type: ''${GREEN}ISOLATED''${NC}"
      else
        echo -e "  âœ— Network type: ''${RED}$CURRENT_NET (NOT ISOLATED!)''${NC}"
      fi

      # Check if forward mode exists
      NET_XML=$(${pkgs.libvirt}/bin/virsh net-dumpxml "$ISOLATED_NET" 2>/dev/null)
      if echo "$NET_XML" | grep -q "<forward"; then
        echo -e "  âœ— Forward mode: ''${RED}ENABLED (DANGEROUS!)''${NC}"
      else
        echo -e "  âœ“ Forward mode: ''${GREEN}DISABLED (no external access)''${NC}"
      fi

      # Check port isolation
      if echo "$NET_XML" | grep -q "isolated=.yes"; then
        echo -e "  âœ“ Port isolation: ''${GREEN}ENABLED''${NC}"
      else
        echo -e "  âš  Port isolation: ''${YELLOW}not enabled''${NC}"
      fi

      # Check iptables for the bridge
      echo ""
      echo "  iptables rules for virbr-malware:"
      ${pkgs.iptables}/bin/iptables -L FORWARD -n 2>/dev/null | grep -E "virbr-malware|malware" | head -5 || echo "    (no specific rules found)"

      echo ""
    }

    status() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        echo ""
        echo "Create VM with: virt-manager"
        echo "Name it exactly: $VM_NAME"
        exit 1
      fi

      VM_STATE=$(${pkgs.libvirt}/bin/virsh domstate "$VM_NAME" 2>/dev/null)
      CURRENT_NET=$(get_network_status)

      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "  Malware Analysis VM Status"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "  VM State:    $VM_STATE"

      if [ "$CURRENT_NET" = "$ISOLATED_NET" ]; then
        echo -e "  Network:     ''${GREEN}ğŸ”’ ISOLATED (safe)''${NC}"
      elif [ "$CURRENT_NET" = "$NAT_NET" ]; then
        echo -e "  Network:     ''${RED}âš ï¸  NAT (internet access!)''${NC}"
      else
        echo -e "  Network:     ''${YELLOW}$CURRENT_NET''${NC}"
      fi
      echo ""

      # Show snapshots
      echo "  Snapshots:"
      ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --name 2>/dev/null | while read snap; do
        [ -n "$snap" ] && echo "    - $snap"
      done
      echo ""
    }

    snapshot_create() {
      local SNAP_NAME="''${1:-clean-$(date +%Y%m%d-%H%M%S)}"

      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      echo "Creating snapshot '$SNAP_NAME'..."
      ${pkgs.libvirt}/bin/virsh snapshot-create-as "$VM_NAME" --name "$SNAP_NAME" --description "Malware analysis snapshot"
      echo -e "''${GREEN}âœ… Snapshot '$SNAP_NAME' created''${NC}"
    }

    snapshot_restore() {
      local SNAP_NAME="$1"

      if [ -z "$SNAP_NAME" ]; then
        echo "Available snapshots:"
        ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --name
        echo ""
        read -p "Enter snapshot name to restore: " SNAP_NAME
      fi

      if [ -z "$SNAP_NAME" ]; then
        echo "No snapshot specified"
        exit 1
      fi

      echo "Restoring snapshot '$SNAP_NAME'..."
      ${pkgs.libvirt}/bin/virsh snapshot-revert "$VM_NAME" --snapshotname "$SNAP_NAME"
      echo -e "''${GREEN}âœ… Restored to '$SNAP_NAME'""''${NC}"

      # Auto-killswitch after restore
      killswitch
    }

    snapshot_list() {
      ${pkgs.libvirt}/bin/virsh snapshot-list "$VM_NAME" --tree
    }

    start_vm() {
      if ! check_vm_exists; then
        echo -e "''${RED}VM '$VM_NAME' not found''${NC}"
        exit 1
      fi

      # Always start in isolated mode
      echo "Starting VM in ISOLATED mode..."
      ${pkgs.libvirt}/bin/virsh start "$VM_NAME" 2>/dev/null || true

      sleep 2
      killswitch

      echo ""
      echo "Opening virt-viewer..."
      ${pkgs.virt-viewer}/bin/virt-viewer --connect qemu:///system "$VM_NAME" &
    }

    show_help() {
      cat << 'EOF'
Malware Analysis VM Manager

Usage: malware-vm <command> [options]

Network Commands:
  killswitch          ğŸ”’ Isolate VM from network (SAFE MODE)
  network-on          âš ï¸  Enable internet (for downloads/updates)
  verify              Check isolation is working correctly
  status              Show VM and network status

Snapshot Commands:
  snapshot [name]     Create a snapshot (default: timestamped)
  restore [name]      Restore to a snapshot (auto-killswitch)
  snapshots           List all snapshots

VM Commands:
  start               Start VM in isolated mode
  setup               Create required networks and nwfilter

Security Layers (when killswitch active):
  1. Isolated network    - No <forward> element = no routing to LAN/internet
  2. Port isolation      - VMs can't see each other on same network
  3. nwfilter            - Blocks all traffic except DHCP/ARP at NIC level
  4. No NAT/masquerade   - No address translation to external networks

Workflow:
  1. Run: malware-vm setup
  2. Create VM in virt-manager named "Windows-Malware"
  3. Run: malware-vm network-on
  4. Install Windows, tools, updates
  5. Run: malware-vm snapshot clean
  6. Run: malware-vm killswitch
  7. Run: malware-vm verify (confirm isolation)
  8. Analyze malware...
  9. Run: malware-vm restore clean

EOF
    }

    # Main
    case "$1" in
      killswitch|kill|off)
        killswitch
        ;;
      network-on|on|net)
        network_on
        ;;
      status|s)
        status
        ;;
      snapshot|snap)
        snapshot_create "$2"
        ;;
      restore|revert)
        snapshot_restore "$2"
        ;;
      snapshots|list)
        snapshot_list
        ;;
      start)
        start_vm
        ;;
      setup)
        create_networks
        echo -e "''${GREEN}âœ… Networks and nwfilter created''${NC}"
        ;;
      verify)
        verify_isolation
        ;;
      help|--help|-h|"")
        show_help
        ;;
      *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
    esac
  '';
in
{
  home.packages = [
    malware-vm
    pkgs.virt-viewer  # For viewing VMs
  ];
}
